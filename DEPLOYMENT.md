# Deployment Guide

## Architecture Overview

```
┌─────────────────┐
│   Telegram      │
│   Users         │
└────────┬────────┘
         │
         │ HTTPS/Webhook
         ▼
┌─────────────────────────────────────┐
│   Deployment Platform               │
│   (Railway/Render/Fly.io)           │
│                                     │
│  ┌──────────────────────────────┐  │
│  │  Telegram Bot (bot_main.py)  │  │
│  │  - Handles messages          │  │
│  │  - Scheduler (APScheduler)   │  │
│  └──────────────────────────────┘  │
│                                     │
│  ┌──────────────────────────────┐  │
│  │  FastAPI (main.py)           │  │
│  │  - Health checks             │  │
│  │  - OAuth callbacks           │  │
│  └──────────────────────────────┘  │
└────────┬───────────────────────────┘
         │
         │ API Calls
         ▼
┌─────────────────────────────────────┐
│   External Services                 │
│   - Google Calendar API             │
│   - Gemini AI API                   │
│   - OpenAI API (fallback)           │
└─────────────────────────────────────┘
         │
         │ SQL Queries
         ▼
┌─────────────────────────────────────┐
│   PostgreSQL Database               │
│   (Supabase/Railway/External)       │
│   - User data                       │
│   - Tasks                           │
│   - Calendar events                 │
│   - Conversations (vector store)    │
└─────────────────────────────────────┘
```

## Deployment Options

### Option 1: Railway.app (Recommended) ⭐

**Pros:**
- Free tier available ($5 credit/month)
- Easy PostgreSQL setup
- Automatic deployments from GitHub
- Simple environment variable management
- Good for beginners

**Cons:**
- Limited free tier
- Can be expensive at scale

#### Steps:

1. **Create Railway Account**
   ```bash
   # Go to railway.app and sign up with GitHub
   ```

2. **Create New Project**
   - Click "New Project"
   - Select "Deploy from GitHub repo"
   - Connect your GitHub account
   - Select the `Thara` repository

3. **Add PostgreSQL Database**
   - Click "New" → "Database" → "Add PostgreSQL"
   - Railway will create database automatically
   - Copy the `DATABASE_URL` from Variables tab

4. **Configure Environment Variables**
   - Go to your service → Variables tab
   - Add all variables from `.env.example`:
     ```
     TELEGRAM_BOT_TOKEN=your_token
     GEMINI_API_KEY=your_key
     DATABASE_URL=<auto-generated by Railway>
     GOOGLE_CLIENT_ID=your_client_id
     GOOGLE_CLIENT_SECRET=your_client_secret
     GOOGLE_REDIRECT_URI=https://your-app.railway.app/auth/callback
     ENVIRONMENT=production
     LOG_LEVEL=INFO
     ```

5. **Enable pgvector Extension**
   - Go to PostgreSQL → Connect → Open in Railway CLI or use psql
   - Run: `CREATE EXTENSION IF NOT EXISTS vector;`

6. **Deploy**
   - Railway will auto-deploy on git push
   - Or click "Deploy" button
   - Check logs for any errors

7. **Run Migrations**
   - Go to service → Deployments → Latest
   - Click "..." → "Run Command"
   - Run: `alembic upgrade head`

8. **Get Your App URL**
   - Railway provides a public URL
   - Update `GOOGLE_REDIRECT_URI` with this URL

**Cost**: Free tier + $5/month credit, then ~$5-20/month

---

### Option 2: Render.com

**Pros:**
- Free tier for web services
- PostgreSQL included
- Easy setup

**Cons:**
- Free tier has limitations (spins down after inactivity)
- Slower cold starts on free tier

#### Steps:

1. **Create Render Account**
   - Go to render.com and sign up

2. **Create PostgreSQL Database**
   - New → PostgreSQL
   - Choose free tier
   - Copy connection string

3. **Create Web Service**
   - New → Web Service
   - Connect GitHub repo
   - Settings:
     - **Build Command**: `pip install -r requirements.txt`
     - **Start Command**: `python bot_main.py`
     - **Environment**: Python 3
   - Add environment variables

4. **Enable pgvector**
   - Connect to database via psql
   - Run: `CREATE EXTENSION IF NOT EXISTS vector;`

5. **Deploy**
   - Render auto-deploys on push
   - Check logs

**Cost**: Free tier available, $7/month for always-on

---

### Option 3: Fly.io

**Pros:**
- Generous free tier
- Global edge deployment
- Good performance

**Cons:**
- More complex setup
- Requires flyctl CLI

#### Steps:

1. **Install flyctl**
   ```bash
   curl -L https://fly.io/install.sh | sh
   ```

2. **Login**
   ```bash
   fly auth login
   ```

3. **Create App**
   ```bash
   fly launch
   ```

4. **Create PostgreSQL**
   ```bash
   fly postgres create
   fly postgres attach <postgres-app-name>
   ```

5. **Set Secrets**
   ```bash
   fly secrets set TELEGRAM_BOT_TOKEN=your_token
   fly secrets set GEMINI_API_KEY=your_key
   # ... etc
   ```

6. **Deploy**
   ```bash
   fly deploy
   ```

**Cost**: Free tier includes 3 VMs, then pay-as-you-go

---

### Option 4: Self-Hosted (VPS)

**Pros:**
- Full control
- Can be cheaper at scale
- No vendor lock-in

**Cons:**
- Requires server management
- Need to handle updates/security
- More setup time

#### Recommended VPS Providers:
- **DigitalOcean**: $6/month droplet
- **Linode**: $5/month
- **Hetzner**: €4/month (Europe)
- **AWS Lightsail**: $5/month

#### Steps:

1. **Set up VPS**
   - Create Ubuntu 22.04 server
   - SSH into server

2. **Install Dependencies**
   ```bash
   sudo apt update
   sudo apt install python3.11 python3-pip postgresql postgresql-contrib
   ```

3. **Set up PostgreSQL**
   ```bash
   sudo -u postgres psql
   CREATE DATABASE thara;
   CREATE USER thara_user WITH PASSWORD 'your_password';
   GRANT ALL PRIVILEGES ON DATABASE thara TO thara_user;
   \q
   ```

4. **Enable pgvector**
   ```bash
   sudo apt install postgresql-14-pgvector  # Adjust version
   sudo -u postgres psql -d thara
   CREATE EXTENSION vector;
   ```

5. **Clone Repository**
   ```bash
   git clone https://github.com/workabhisehk/Thara.git
   cd Thara
   ```

6. **Set up Python Environment**
   ```bash
   python3 -m venv venv
   source venv/bin/activate
   pip install -r requirements.txt
   ```

7. **Configure Environment**
   ```bash
   cp .env.example .env
   nano .env  # Edit with your values
   ```

8. **Run Migrations**
   ```bash
   alembic upgrade head
   ```

9. **Set up Systemd Service**
   ```bash
   sudo nano /etc/systemd/system/thara-bot.service
   ```
   Content:
   ```ini
   [Unit]
   Description=Thara AI Productivity Bot
   After=network.target

   [Service]
   Type=simple
   User=your_user
   WorkingDirectory=/home/your_user/Thara
   Environment="PATH=/home/your_user/Thara/venv/bin"
   ExecStart=/home/your_user/Thara/venv/bin/python bot_main.py
   Restart=always

   [Install]
   WantedBy=multi-user.target
   ```

10. **Start Service**
    ```bash
    sudo systemctl daemon-reload
    sudo systemctl enable thara-bot
    sudo systemctl start thara-bot
    sudo systemctl status thara-bot
    ```

11. **Set up Nginx (for OAuth callbacks)**
    ```bash
    sudo apt install nginx
    sudo nano /etc/nginx/sites-available/thara
    ```
    Content:
    ```nginx
    server {
        listen 80;
        server_name your-domain.com;

        location / {
            proxy_pass http://localhost:8000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
    }
    ```
    ```bash
    sudo ln -s /etc/nginx/sites-available/thara /etc/nginx/sites-enabled/
    sudo nginx -t
    sudo systemctl restart nginx
    ```

---

## Environment Variables Reference

### Required Variables

```bash
# Telegram
TELEGRAM_BOT_TOKEN=your_bot_token_from_botfather

# AI/LLM
GEMINI_API_KEY=your_gemini_api_key
OPENAI_API_KEY=your_openai_key_optional_for_fallback

# Database
DATABASE_URL=postgresql://user:password@host:port/database

# Google Calendar OAuth
GOOGLE_CLIENT_ID=your_google_client_id
GOOGLE_CLIENT_SECRET=your_google_client_secret
GOOGLE_REDIRECT_URI=https://your-domain.com/auth/callback

# Application
ENVIRONMENT=production
LOG_LEVEL=INFO
TIMEZONE=UTC
```

### Optional Variables

```bash
# Work Hours (defaults shown)
DEFAULT_WORK_START_HOUR=8
DEFAULT_WORK_END_HOUR=20
DEFAULT_WEEKEND_START_HOUR=10
DEFAULT_WEEKEND_END_HOUR=18

# Scheduling
CHECK_IN_INTERVAL=30
WEEKLY_REVIEW_HOUR=10

# Server
HOST=0.0.0.0
PORT=8000
```

---

## Post-Deployment Checklist

- [ ] Bot responds to `/start` command
- [ ] Database migrations completed successfully
- [ ] Google Calendar OAuth flow works
- [ ] Scheduled jobs are running (check logs)
- [ ] Health check endpoint responds: `https://your-domain.com/health`
- [ ] No errors in application logs
- [ ] Environment variables are set correctly
- [ ] pgvector extension is enabled in database

---

## Monitoring & Maintenance

### Health Checks

The bot exposes a health endpoint:
```
GET /health
```

Response:
```json
{
  "status": "healthy",
  "environment": "production",
  "version": "1.0.0"
}
```

### Logs

Check logs regularly:
- **Railway**: Service → Deployments → View Logs
- **Render**: Logs tab in dashboard
- **Fly.io**: `fly logs`
- **Self-hosted**: `journalctl -u thara-bot -f`

### Database Backups

**Supabase**: Automatic backups (check settings)  
**Railway**: Manual backups via CLI  
**Self-hosted**: Set up cron job:
```bash
0 2 * * * pg_dump -U thara_user thara > /backups/thara_$(date +\%Y\%m\%d).sql
```

---

## Troubleshooting

### Bot Not Responding
1. Check TELEGRAM_BOT_TOKEN is correct
2. Verify bot is running (check logs)
3. Ensure webhook is not set (we use polling)

### Database Connection Errors
1. Verify DATABASE_URL format
2. Check database is accessible
3. Ensure pgvector extension is installed

### Calendar OAuth Fails
1. Verify redirect URI matches exactly
2. Check GOOGLE_CLIENT_ID and SECRET
3. Ensure Calendar API is enabled in Google Cloud

### Scheduler Not Working
1. Check timezone settings
2. Verify APScheduler is running (check logs)
3. Ensure system time is correct

---

## Cost Estimates

| Platform | Free Tier | Paid Tier | Best For |
|----------|-----------|-----------|----------|
| Railway | $5 credit/month | $5-20/month | Quick start |
| Render | Limited free | $7/month | Simple setup |
| Fly.io | 3 VMs free | Pay-as-you-go | Global scale |
| Self-hosted | N/A | $5-10/month | Full control |

---

## Recommended Setup for Production

1. **Database**: Supabase (free tier, includes backups)
2. **Application**: Railway.app (easy deployment)
3. **Monitoring**: Railway's built-in logs + Sentry (optional)
4. **Backups**: Supabase automatic + manual exports weekly

---

## Next Steps After Deployment

1. Test all features thoroughly
2. Set up monitoring/alerting
3. Configure backups
4. Review security settings
5. Document any custom configurations

